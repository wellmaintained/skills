#!/bin/bash
# BD wrapper for git worktrees
# Automatically detects worktree context and sets appropriate flags
#
# This script is called when 'bd' is invoked in a worktree because
# ./scripts is prepended to PATH in .envrc
#
# Usage: bd <command> [args...]
# Example: bd ready --json

# Find the real bd executable (not this script)
# Remove ./scripts from PATH temporarily to find the system bd
PATH_WITHOUT_SCRIPTS=$(echo "$PATH" | tr ':' '\n' | grep -v "$(cd "$(dirname "$0")" && pwd)" | tr '\n' ':')
REAL_BD=$(PATH="$PATH_WITHOUT_SCRIPTS" command -v bd)

if [ -z "$REAL_BD" ]; then
    echo "Error: Could not find bd executable in PATH" >&2
    exit 1
fi

# Detect if we're in a worktree by checking if .git is a file
if [ -f ".git" ]; then
    # We're in a worktree
    WORKTREE_NAME=$(basename "$PWD")
    WORKTREE_DB="$PWD/.beads/beads.db"

    # Call real bd with worktree-specific flags
    exec "$REAL_BD" --actor "$WORKTREE_NAME" --db "$WORKTREE_DB" "$@"
else
    # We're in main repo, use defaults
    exec "$REAL_BD" "$@"
fi
