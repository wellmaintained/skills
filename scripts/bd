#!/bin/bash
# BD wrapper for git worktrees
# Automatically detects worktree context and sets appropriate flags
#
# This script is called when 'bd' is invoked in a worktree because
# ./scripts is prepended to PATH in .envrc
#
# Usage: bd <command> [args...]
# Example: bd ready --json

# Find the real bd executable (not this script)
# Remove ./scripts from PATH temporarily to find the system bd
PATH_WITHOUT_SCRIPTS=$(echo "$PATH" | tr ':' '\n' | grep -v "$(cd "$(dirname "$0")" && pwd)" | tr '\n' ':')
REAL_BD=$(PATH="$PATH_WITHOUT_SCRIPTS" command -v bd)

if [ -z "$REAL_BD" ]; then
    echo "Error: Could not find bd executable in PATH" >&2
    exit 1
fi

# Detect if we're in a worktree by checking if .git is a file
if [ -f ".git" ]; then
    # We're in a worktree
    WORKTREE_NAME=$(basename "$PWD")
    WORKTREE_DB="$PWD/.beads/beads.db"

    # Log wrapper activity to stderr (won't interfere with JSON output)
    echo "ðŸ”§ BD Worktree Wrapper: Using isolated database for '$WORKTREE_NAME'" >&2
    echo "   Flags: --actor '$WORKTREE_NAME' --db '$WORKTREE_DB' --allow-stale" >&2

    # Call real bd with worktree-specific flags
    # Add --allow-stale to bypass staleness check issues in worktree contexts
    # The staleness check can be overly aggressive when working with isolated
    # worktree databases, even when the database is properly synced
    exec "$REAL_BD" --actor "$WORKTREE_NAME" --db "$WORKTREE_DB" --allow-stale "$@"
else
    # We're in main repo, use defaults
    exec "$REAL_BD" "$@"
fi
