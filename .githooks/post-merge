#!/bin/sh
# bd-hooks-version: 0.23.0 (modified for jsonl_file_hash sync)
#
# bd (beads) post-merge hook
#
# This hook syncs the bd database after a git pull or merge:
# 1. Checks if any .beads/*.jsonl file was updated
# 2. Runs 'bd sync --import-only' to import changes
# 3. Runs 'bd sync --flush-only' to update jsonl_file_hash metadata
#
# Installation:
#   git config core.hooksPath .githooks
#   chmod +x .githooks/post-merge

# Check if bd is available
if ! command -v bd >/dev/null 2>&1; then
    echo "Warning: bd command not found, skipping post-merge sync" >&2
    exit 0
fi

# Check if we're in a bd workspace
if [ ! -d .beads ]; then
    # Not a bd workspace, nothing to do
    exit 0
fi

# Check if any JSONL file exists in .beads/
if ! ls .beads/*.jsonl >/dev/null 2>&1; then
    exit 0
fi

# Run bd sync --import-only to import the updated JSONL
# This is more robust than direct import as it handles all edge cases
# Capture both stdout and stderr to show user what went wrong
if ! output=$(bd sync --import-only 2>&1); then
    echo "Warning: Failed to sync bd changes after merge" >&2
    echo "$output" >&2
    echo "" >&2
    echo "Run 'bd sync --import-only' manually to resolve" >&2
    # Don't fail the merge, just warn
fi

# Run a flush-only export to update jsonl_file_hash metadata
# This prevents staleness errors on subsequent bd commands
# The import updated last_import_hash, but jsonl_file_hash stays stale
# without an export to sync it
bd sync --flush-only >/dev/null 2>&1 || true

exit 0
