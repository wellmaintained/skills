name: CI

on:
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - 'plugins/**'
      - 'src/**'  # Trigger on source changes (beads-bridge CLI)
      - '.claude-plugin/marketplace.json'
      - 'schemas/**'  # Trigger on schema changes
      - '.github/workflows/**'  # Also trigger on workflow changes
  push:
    branches:
      - main
    paths:
      - 'plugins/**'
      - 'src/**'  # Trigger on source changes (beads-bridge CLI)
      - '.claude-plugin/marketplace.json'
      - 'schemas/**'  # Trigger on schema changes
      - '.github/workflows/**'  # Also trigger on workflow changes

jobs:
  validate-structure:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install ajv-cli for schema validation
        run: bun install -g ajv-cli ajv-formats

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Validate plugin structure
        run: just validate-structure

  test-beads-bridge:
    name: Test Beads-Bridge
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Install dependencies
        run: just install-bridge

      - name: Lint
        run: just lint-bridge

      - name: Type check
        run: just type-check-bridge

      - name: Build
        run: just build-bridge

      - name: Test
        run: just test-bridge

  # Determine version using semantic-release dry-run
  determine-version:
    name: Determine Version
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [validate-structure, test-beads-bridge]
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      should-release: ${{ steps.get-version.outputs.should-release }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get next version
        id: get-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run semantic-release in dry-run mode and capture output
          OUTPUT=$(bun x semantic-release --dry-run 2>&1) || true
          echo "$OUTPUT"

          # Extract version from output (look for "Release X.Y.Z" or similar)
          VERSION=$(echo "$OUTPUT" | grep -oP "(?<=The next release version is )\d+\.\d+\.\d+" || echo "")

          if [ -n "$VERSION" ]; then
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "Next version will be: $VERSION"
          else
            # Fallback to git describe if no release pending
            VERSION=$(git describe --tags --always | sed 's/^v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "No release pending, using git describe: $VERSION"
          fi

  build-binaries:
    name: Build Binaries
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [determine-version]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: macos-latest
            platform: darwin
            arch: x64
          - os: windows-latest
            platform: win32
            arch: x64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Build binary for platform
        env:
          BUILD_VERSION: ${{ needs.determine-version.outputs.version }}
        run: just build-binary ${{ matrix.platform }} ${{ matrix.arch }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}
          path: src/beads-bridge/dist/beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}*
          retention-days: 1

  update-marketplace:
    name: Update Marketplace Catalog
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [validate-structure, test-beads-bridge]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Update marketplace.json timestamp
        run: just update-marketplace-timestamp

      - name: Commit updated marketplace.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update marketplace.json timestamp [skip ci]"
          file_pattern: .claude-plugin/marketplace.json

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [build-binaries, update-marketplace, determine-version]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.determine-version.outputs.should-release == 'true'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: src/beads-bridge/dist/

      - name: Organize binaries
        run: |
          cd src/beads-bridge/dist
          # Move binaries from artifact subdirectories to dist root
          find . -type f -name "beads-bridge-*" -exec mv {} . \;
          # Remove empty artifact directories
          find . -type d -empty -delete
          ls -la

      - name: Pull latest changes
        run: git pull origin main

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun x semantic-release
