name: CI

on:
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - 'plugins/**'
      - 'src/**'  # Trigger on source changes (beads-bridge CLI)
      - '.claude-plugin/marketplace.json'
      - 'schemas/**'  # Trigger on schema changes
      - '.github/workflows/**'  # Also trigger on workflow changes
  push:
    branches:
      - main
    paths:
      - 'plugins/**'
      - 'src/**'  # Trigger on source changes (beads-bridge CLI)
      - '.claude-plugin/marketplace.json'
      - 'schemas/**'  # Trigger on schema changes
      - '.github/workflows/**'  # Also trigger on workflow changes

jobs:
  validate-structure:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install ajv-cli for schema validation
        run: bun install -g ajv-cli ajv-formats

      - name: Validate marketplace.json syntax
        run: |
          echo "Validating marketplace.json JSON syntax..."
          if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
            echo "❌ .claude-plugin/marketplace.json is not valid JSON"
            exit 1
          fi
          echo "✅ .claude-plugin/marketplace.json has valid JSON syntax"

      - name: Validate marketplace.json schema
        run: |
          echo "Validating marketplace.json against schema..."
          if ! ajv validate -s schemas/marketplace.schema.json -d .claude-plugin/marketplace.json --spec=draft7 --strict=false -c ajv-formats; then
            echo "❌ .claude-plugin/marketplace.json does not conform to schema"
            exit 1
          fi
          echo "✅ .claude-plugin/marketplace.json conforms to schema"

      - name: Validate plugin.json files syntax
        run: |
          echo "Validating JSON syntax for all plugin.json files..."
          find plugins -name "plugin.json" -type f | while read plugin_file; do
            echo "Checking syntax: $plugin_file..."
            if ! jq empty "$plugin_file" 2>/dev/null; then
              echo "❌ $plugin_file is not valid JSON"
              exit 1
            fi
            echo "✅ $plugin_file has valid JSON syntax"
          done

      - name: Validate plugin.json files schema
        run: |
          echo "Validating all plugin.json files against schema..."
          find plugins -name "plugin.json" -type f | while read plugin_file; do
            echo "Validating schema: $plugin_file..."
            if ! ajv validate -s schemas/plugin.schema.json -d "$plugin_file" --spec=draft7 --strict=false -c ajv-formats; then
              echo "❌ $plugin_file does not conform to schema"
              exit 1
            fi
            echo "✅ $plugin_file conforms to schema"
          done

      - name: Check required files
        run: |
          echo "Checking required files for each plugin..."
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "Checking plugin: $plugin_name"

            # Check for required files
            required_files=(
              ".claude-plugin/plugin.json"
              "README.md"
              "QUICKSTART.md"
              "LICENSE"
            )

            for file in "${required_files[@]}"; do
              if [ ! -f "$plugin_dir$file" ]; then
                echo "❌ Missing required file: $plugin_dir$file"
                exit 1
              fi
            done

            echo "✅ All required files present for $plugin_name"
          done

      - name: Validate directory structure
        run: |
          echo "Validating plugin directory structure..."
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "Checking structure for: $plugin_name"

            # Check .claude-plugin is at root
            if [ ! -d "$plugin_dir.claude-plugin" ]; then
              echo "❌ Missing .claude-plugin directory at plugin root: $plugin_dir"
              exit 1
            fi

            # Check skills directory structure
            if [ -d "$plugin_dir/skills" ]; then
              # Skills should be at skills/skill-name/SKILL.md, not skills/SKILL.md
              if [ -f "$plugin_dir/skills/SKILL.md" ]; then
                echo "❌ Found SKILL.md at wrong level: $plugin_dir/skills/SKILL.md"
                echo "   Skills should be at skills/<skill-name>/SKILL.md"
                exit 1
              fi

              # Check for source files at wrong level
              if [ -d "$plugin_dir/skills/src" ] || [ -d "$plugin_dir/skills/tests" ]; then
                echo "❌ Found src/tests directories at wrong level in $plugin_dir/skills/"
                echo "   Source files should be at skills/<skill-name>/src/"
                exit 1
              fi

              # Check for package.json at wrong level
              if [ -f "$plugin_dir/skills/package.json" ]; then
                echo "❌ Found package.json at wrong level: $plugin_dir/skills/package.json"
                echo "   package.json should be at skills/<skill-name>/package.json"
                exit 1
              fi
            fi

            echo "✅ Directory structure is correct for $plugin_name"
          done

      - name: Check version consistency
        run: |
          echo "Checking version consistency across plugins..."
          bash scripts/check-version-consistency.sh

  test-plugins:
    name: Test Plugin Installation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugin:
          - beads-bridge
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Test installation script
        run: |
          cd plugins/${{ matrix.plugin }}
          if [ -f ".claude-plugin/install.sh" ]; then
            echo "Testing installation script for ${{ matrix.plugin }}..."
            bash .claude-plugin/install.sh || true  # Allow to fail if dependencies not available
            echo "✅ Installation script executed"
          else
            echo "ℹ️  No installation script for ${{ matrix.plugin }}"
          fi

      - name: Install dependencies and build
        run: |
          # Check if beads-bridge is extracted to src/
          if [ "${{ matrix.plugin }}" = "beads-bridge" ] && [ -d "src/beads-bridge" ]; then
            cd src/beads-bridge
          elif [ -d "plugins/${{ matrix.plugin }}/skills/${{ matrix.plugin }}" ]; then
            cd plugins/${{ matrix.plugin }}/skills/${{ matrix.plugin }}
          else
            echo "⚠️  No build needed for ${{ matrix.plugin }}"
            exit 0
          fi

          if [ -f "package.json" ]; then
            echo "Installing dependencies for ${{ matrix.plugin }}..."
            bun install
            echo "Building ${{ matrix.plugin }}..."
            bun run build
          fi

      - name: Run plugin tests (if available)
        run: |
          # Check if beads-bridge is extracted to src/
          if [ "${{ matrix.plugin }}" = "beads-bridge" ] && [ -d "src/beads-bridge" ]; then
            cd src/beads-bridge
          elif [ -d "plugins/${{ matrix.plugin }}/skills/${{ matrix.plugin }}" ]; then
            cd plugins/${{ matrix.plugin }}/skills/${{ matrix.plugin }}
          else
            echo "ℹ️  No tests available for ${{ matrix.plugin }}"
            exit 0
          fi

          if [ -f "package.json" ] && jq -e '.scripts.test' package.json > /dev/null; then
            echo "Running tests for ${{ matrix.plugin }}..."
            bun run test || echo "⚠️ Some tests failed (allowing for now)"
            echo "✅ Tests completed"
          else
            echo "ℹ️  No tests defined for ${{ matrix.plugin }}"
          fi

  build-binaries:
    name: Build Binaries
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [validate-structure, test-plugins]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: macos-13
            platform: darwin
            arch: x64
          - os: windows-latest
            platform: win32
            arch: x64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies and build binary
        run: |
          cd src/beads-bridge
          bun install
          bun run build

      - name: Rename binary with platform suffix
        shell: bash
        run: |
          cd src/beads-bridge/dist
          if [ "${{ matrix.platform }}" = "win32" ]; then
            mv beads-bridge beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}.exe || mv beads-bridge.exe beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}.exe
          else
            mv beads-bridge beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}
          path: src/beads-bridge/dist/beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}*
          retention-days: 1

  update-marketplace:
    name: Update Marketplace Catalog
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [validate-structure, test-plugins]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update marketplace.json timestamp
        run: |
          echo "Updating marketplace.json lastUpdated timestamp..."
          jq '.metadata.lastUpdated = (now | todate)' .claude-plugin/marketplace.json > .claude-plugin/marketplace.json.tmp
          mv .claude-plugin/marketplace.json.tmp .claude-plugin/marketplace.json

      - name: Commit updated marketplace.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update marketplace.json timestamp [skip ci]"
          file_pattern: .claude-plugin/marketplace.json

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [build-binaries, update-marketplace]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: src/beads-bridge/dist/

      - name: Organize binaries
        run: |
          cd src/beads-bridge/dist
          # Move binaries from artifact subdirectories to dist root
          find . -type f -name "beads-bridge-*" -exec mv {} . \;
          # Remove empty artifact directories
          find . -type d -empty -delete
          ls -la

      - name: Pull latest changes
        run: git pull origin main

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun x semantic-release
