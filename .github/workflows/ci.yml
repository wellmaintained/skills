name: CI

on:
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - 'plugins/**'
      - 'src/**'  # Trigger on source changes (beads-bridge CLI)
      - '.claude-plugin/marketplace.json'
      - 'schemas/**'  # Trigger on schema changes
      - '.github/workflows/**'  # Also trigger on workflow changes
  push:
    branches:
      - main
    paths:
      - 'plugins/**'
      - 'src/**'  # Trigger on source changes (beads-bridge CLI)
      - '.claude-plugin/marketplace.json'
      - 'schemas/**'  # Trigger on schema changes
      - '.github/workflows/**'  # Also trigger on workflow changes

jobs:
  validate-structure:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install ajv-cli for schema validation
        run: bun install -g ajv-cli ajv-formats

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Validate plugin structure
        run: just validate-structure

  test-plugins:
    name: Test Plugin Installation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        plugin:
          - beads-bridge
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Test installation script
        run: just test-plugin-install ${{ matrix.plugin }}

      - name: Build and test plugin
        run: just test-plugin ${{ matrix.plugin }}

  build-binaries:
    name: Build Binaries
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [validate-structure, test-plugins]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: macos-latest
            platform: darwin
            arch: x64
          - os: windows-latest
            platform: win32
            arch: x64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Build binary for platform
        run: just build-binary ${{ matrix.platform }} ${{ matrix.arch }}

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}
          path: src/beads-bridge/dist/beads-bridge-${{ matrix.platform }}-${{ matrix.arch }}*
          retention-days: 1

  update-marketplace:
    name: Update Marketplace Catalog
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [validate-structure, test-plugins]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Just
        uses: extractions/setup-just@v2

      - name: Update marketplace.json timestamp
        run: just update-marketplace-timestamp

      - name: Commit updated marketplace.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update marketplace.json timestamp [skip ci]"
          file_pattern: .claude-plugin/marketplace.json

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [build-binaries, update-marketplace]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          path: src/beads-bridge/dist/

      - name: Organize binaries
        run: |
          cd src/beads-bridge/dist
          # Move binaries from artifact subdirectories to dist root
          find . -type f -name "beads-bridge-*" -exec mv {} . \;
          # Remove empty artifact directories
          find . -type d -empty -delete
          ls -la

      - name: Pull latest changes
        run: git pull origin main

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bun x semantic-release
